name: Enforce PR Branch Policy

on:
  pull_request:
    types: [ opened, reopened, edited ]

jobs:
  enforce-pr-policy:
    runs-on: ubuntu-latest
    steps:
      - name: Enforce PR target rules
        uses: actions/github-script@v7
        with:
          script: |
            const base = context.payload.pull_request.base.ref;
            const head = context.payload.pull_request.head.ref;
            const prNumber = context.payload.pull_request.number;
            const repo = context.repo;

            // Función auxiliar para evaluar si una rama es del tipo permitido
            function matchesPattern(patterns, branchName) {
              return patterns.some(pattern => new RegExp(`^${pattern.replace("*", ".*")}$`).test(branchName));
            }

            const allowedToMain = ["develop", "release/.*"];
            const allowedToDevelop = [".*"]; // todas las ramas pueden apuntar a develop

            if (base === "main") {
              if (!matchesPattern(allowedToMain, head)) {
                await github.rest.issues.createComment({
                  ...repo,
                  issue_number: prNumber,
                  body: `🚫 Esta pull request intenta hacer merge desde \`${head}\` a \`main\`, lo cual no está permitido.\n\n🛠️ Solo se permite PR hacia \`main\` desde \`develop\` o ramas \`release/*\`.\n\nPor favor, redirige esta PR hacia \`develop\` si es una rama de desarrollo.`
                });

                // ❌ Opción: cerrar automáticamente la PR
                // await github.rest.pulls.update({
                //   ...repo,
                //   pull_number: prNumber,
                //   state: 'closed'
                // });
              }
            } else if (base === "develop") {
              // Todo ok
            } else {
              // Opcional: agregar validaciones para otras ramas base
            }
